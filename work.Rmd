
```{r}
library(tidyverse)
library(mirt)
R.utils::sourceDirectory("R")
```

```{r}
pars_1_dif <-
    read_csv("data-parameters/kopf2015-8.csv") %>%
    arrange(desc(easy)) %>%
    mutate(
        item = row_number(),
        nuisance_disc = c(0, 0, 0, 0.3, 0, 0, 0.3, 0)
    )

sim_1_dif <- sim_bias(pars = pars_1_dif, n_ref = 50000, n_foc = 50000, mean_foc = -1)
```

```{r}
get_next_status <- function(status, data, groups){
    the_flex <- which(status$status == "flex")
    
    status %>% 
        filter(status == "unknown") %>% 
        mutate(
            p = item %>% 
                map_dbl(~ test_with_known_flex(data, groups, flex_known = the_flex, flex_test = .))
        ) %>% 
        select(-status)
}
```

```{r}
all_other <- dif_all_other(data = sim_1_dif$data, groups = sim_1_dif$groups)


```

```{r}
dif_iterative_backward(data, groups){
    
    dif_cb <- dif_all_other(data, groups)
    
    if (all(dif_cb$p > 0.05)){
        return(
            dif_cb %>% 
                mutate(
                    status = ifelse(item == which.min(p), "flex", "unknown")
                )
        )
    }

    status <- 
        dif_cb %>% 
        mutate(
            status = ifelse(item == which.min(p), "flex", "unknown")
        )

    while(TRUE){
        new_status <- get_next_status(status, sim_1_dif$data, sim_1_dif$groups)
    
        status <- 
            status %>% 
            select(-p) %>% 
            left_join(new_status, by = "item")
        
        if(all(status$p > 0.05, na.rm = TRUE)){break}
    
        status$status[which.min(status$p)] <- "flex"
    }
    
    status
}





```

```{r}
mod <- 
    multipleGroup(
        sim_1_dif$data,
        1,
        itemtype = "Rasch",
        sim_1_dif$groups,
        invariance = c("free_var"),
        technical = list(NCYCLES = 100),
        SE = TRUE
    )

mod %>% 
    mod_to_draws_df() %>% 
    draws_df_to_logit_plot()
```

```{r}
pars_3_dif <-
    read_csv("data-parameters/kopf2015-8.csv") %>%
    arrange(desc(easy)) %>%
    mutate(
        item = row_number(),
        nuisance_disc = c(0, 0, 0, 0.5, 0.5, 0.5, 0, 0)
    )
```



